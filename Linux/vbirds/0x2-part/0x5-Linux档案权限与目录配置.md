# 第二部分 第五章 Linux的档案权限与目录配置

## 1、使用者与群组

### 档案拥有者

由于Linux是个多人多工的系统，因此可能会有多人同时使用电脑工作的情况发生，为了考虑每个人的隐私权以及每个人喜好的工作环境，这个`档案拥有者`的角色就相当重要了。尤其是在这个具有相当健全而好用的安全防护功能的`使用者群组`的功能下。  

例如：你的隐私，因为你是拥有者，权限设置为只有你才能看到，那么别人哪怕知道你有这个文档，但是因为没有权限，也无法知道这个文档的内容。  

### 群组概念

那麼群組呢？為何要設定檔案還有所屬的群組？其實，群組最有用的功能之一，就是當你在團隊開發資源的時候啦！ 舉例來說，假設有兩組專題生在我的主機裡面，第一個專題組別為projecta，裡面的成員有 class1, class2, class3三個；第二個專題組別為projectb，裡面的成員有class4, class5, class6。 這兩個專題之間是有競爭性質的，但卻要繳交同一份報告。每組的組員之間必須要能夠互相修改對方的資料， 但是其他組的組員則不能看到本組自己的檔案內容，此時該如何是好？

在Linux底下這樣的限制是很簡單啦！我可以經由簡易的檔案權限設定，就能限制非自己團隊(亦即是群組囉) 的其他人不能夠閱覽內容囉！而且亦可以讓自己的團隊成員可以修改我所建立的檔案！ 同時，如果我自己還有私人隱密的文件，仍然可以設定成讓自己的團隊成員也看不到我的檔案資料。 很方便吧！

另外，如果teacher這個帳號是projecta與projectb這兩個專題的老師， 他想要同時觀察兩者的進度，因此需要能夠進入這兩個群組的權限時，你可以設定teacher這個帳號， 『同時支援projecta與projectb這兩個群組！』，也就是說：每個帳號都可以有多個群組的支援呢！

這樣說或許你還不容易理解這個使用者與群組的關係吧？沒關係，我們可以使用目前『家庭』的觀念來進行解說喔！ 假設有一家人，家裡只有三兄弟，分別是王大毛、王二毛與王三毛三個人， 而這個家庭是登記在王大毛的名下的！所以，『王大毛家有三個人，分別是王大毛、王二毛與王三毛』， 而且這三個人都有自己的房間，並且共同擁有一個客廳喔！

- 使用者的意義：由於王家三人各自擁有自己的房間，所以， 王二毛雖然可以進入王三毛的房間，但是二毛不能翻三毛的抽屜喔！那樣會被三毛K的！ 因為抽屜裡面可能有三毛自己私人的東西，例如情書啦，日記啦等等的，這是『私人的空間』，所以當然不能讓二毛拿囉！

- 群組的概念：由於共同擁有客廳，所以王家三兄弟可以在客廳打開電視機啦、 翻閱報紙啦、坐在沙發上面發呆啦等等的！ 反正，只要是在客廳的玩意兒，三兄弟都可以使用喔！ 因為大家都是一家人嘛！

這樣說來應該有點曉得了喔！那個『王大毛家』就是所謂的『群組』囉， 至於三兄弟就是分別為三個『使用者』，而這三個使用者是在同一個群組裡面的喔！ 而三個使用者雖然在同一群組內，但是我們可以設定『權限』， 好讓某些使用者個人的資訊不被群組的擁有者查詢，以保有個人『私人的空間』啦！ 而設定群組共享，則可讓大家共同分享喔！

### 其他人的概念


好了，那麼今天又有個人，叫做張小豬，他是張小豬家的人，與王家沒有關係啦！ 這個時候，除非王家認識張小豬，然後開門讓張小豬進來王家，否則張小豬永遠沒有辦法進入王家， 更不要說進到王三毛的房間啦！不過，如果張小豬透過關係認識了三毛，並且跟王三毛成為好朋友， 那麼張小豬就可以透過三毛進入王家啦！呵呵！沒錯！那個張小豬就是所謂的『其他人，Others』囉！

---

因此，我們就可以知道啦，在Linux裡面，任何一個檔案都具有『User, Group及Others』三種身份的個別權限。  
我們以王三毛為例，王三毛這個『檔案』的擁有者為王三毛，他屬於王大毛這個群組， 而張小豬相對於王三毛，則只是一個『其他人(others)』而已。

不過，這裡有個特殊的人物要來介紹的，那就是『萬能的天神』！這個天神具有無限的神力， 所以他可以到達任何他想要去的地方，呵呵！那個人在Linux系統中的身份代號是『 root 』啦！所以要小心喔！那個root可是『萬能的天神』喔！

無論如何，『使用者身份』，與該使用者所支援的『群組』概念，在Linux的世界裡面是相當的重要的， 他可以幫助你讓你的多工Linux環境變的更容易管理！更詳細的 『身份與群組』 設定，我們將在第十三章、帳號管理再進行解說。 底下我們將針對檔案系統與檔案權限來進行說明。

### Linux使用者身份与群组记录的档案

我们在linux系统档中，预设的情况下，所有的系统上的账号与一般身份使用者，还有那个root的相关资讯，  
都记录在 `/etc/passwd` 这个档案内。  
个人密码记录在 `/etc/shadow` 这个档案下。  
所有群组名称记录在 `/etc/group` 这个档案下。  
这三个档案可以说是Linux系统里面账号、密码、群组资讯的集中第。不要随便删除这三个档案啊！  

---

## 2、Linux档案权限概念

档案权限如何针对这些所谓的**使用者**与**群组**来设定呢？  
这部分相当重要，是学Linux的一个相当重要的关卡，如果没有这部分的概念，你将老师听不懂别人在说什么。  
亦或者是屏幕出现 `Permission deny` 的时候，别担心，肯定是权限设定错误啦。  

### 2.1、Linux档案属性，改变语系的 locale

首先，用普通用户登录（不建议直接登录root），使用 `su -` 切换到root用户（相当于用友root权限），最后可以输入 `exit` 退出root返回到普通用户。  

ls指令：（list：列表的意思），【-alh】a：all（显示隐藏文件，前面带点的）、l：list（详细列表，显示权限、节点、拥有者、群组等等）、h：human（以人类刻度的字节数显示文档大小）  

```
[dmtsai@study ~]$ su -  # 先來切換一下身份看看
Password:
Last login: Tue Jun  2 19:32:31 CST 2015 on tty2
[root@study ~]# ls -al
total 48
dr-xr-x---.  5    root     root    4096  May 29 16:08 .
dr-xr-xr-x. 17    root     root    4096  May  4 17:56 ..
-rw-------.  1    root     root    1816  May  4 17:57 anaconda-ks.cfg
-rw-------.  1    root     root     927  Jun  2 11:27 .bash_history
-rw-r--r--.  1    root     root      18  Dec 29  2013 .bash_logout
-rw-r--r--.  1    root     root     176  Dec 29  2013 .bash_profile
-rw-r--r--.  1    root     root     176  Dec 29  2013 .bashrc
drwxr-xr-x.  3    root     root      17  May  6 00:14 .config               <=範例說明處
drwx------.  3    root     root      24  May  4 17:59 .dbus
-rw-r--r--.  1    root     root    1864  May  4 18:01 initial-setup-ks.cfg  <=範例說明處
[    1    ][  2 ][   3  ][  4 ][    5   ][    6     ] [       7          ]
[  權限   ][連結][擁有者][群組][檔案容量][ 修改日期 ] [      檔名        ]
```

---

#### 1 —— 这个档案的类型与权限

一共10个字符：（例如：`-rwxr--r--`）

- 第一个字符代表这个档案类型
	- 【d】：目录
	- 【-】：文档（档案）
	- 【l】：链接档/连接档（link file）
	- 【b】：装置当里面的可供存储的周边设备（可随机读取装置）；
	- 【c】：装置档案里面的序列埠设备，例如鼠标、键盘（一次性读取装置）

- 接下来的字符，三个一组，且均为 `rwx` 三个参数的组合。
	- 【r】：可读（read）
	- 【w】：可写（write）
	- 【x】：可执行（execute）
	- 要注意：这三个权限的位置不会改变，如果没有权限，就会出现`-`而已。
	- -------
	- 第一组：档案拥有者可具备的权限
	- 第二组：加入此群组之账号的权限
	- 第三组：非本人且没加入本群组之其他账号的权限


#### 2 -- 有多少个档名连接到此节点（i-node）：

每个档案都会将它的权限与属性记录到档案系统的i-node中，不过，我们使用的目录树却是使用档名来记录，因此每个档名就会连接到一个i-node喽！  
这个属性记录的，就是有多少不同的档名连接到相同的一个i-node号码去就是了。

#### 3 -- 这个档案（或目录）的【拥有者账号】

#### 4 -- 这个档案的所属群组

在linux系统下，一个账号会加入于一个或多个的群组。

#### 5 -- 这个档案的容量大小，预设单位为bytes

这里用ls的时候，可以使用-h指令，以人类客户的形式展示出来，（就是会显示G、M、K、B等等单位）  

#### 6 -- 这个档案的建档日期或者是最近的修改日期

这一栏的内容分别为日期（月/日）及时间。如果这个档案被修改的时间距离现在太久了，那么时间部分会仅显示年份而已。  
如果想要显示完整的时间格式，可以利用ls的选项：`ls -l --full-time`  
另外如果安装的Linux是中文版，那么日期栏会以中文显示出来。  
如果中文没办法在纯文字的终端机模式中正确的显示，就会变成乱码。  
那就要使用 `export LC_ALL=en_US.utf8`来修改语系。  

**如果想要让系统预设的语系变成英文的话，那么可以修改系统设定档`/etc/locale.conf`**

#### 7 -- 这个档案的名称

这个就是档名了，如果前面多一个【.】，则代表这个档是【隐藏档】  
可以使用：`ls -a` 来显示隐藏档。  

----

#### Linux档案权限的重要性

相比windows，Linux系统的每个档案都多家了多个属性进来，尤其是群组的概念，其最大的用途是在【资料安全性】上面。  

- 系统保护的功能：
	- 例如：在系统中，关于系统服务的档案通常中油root才能读写或执行，例如`/etc/shadow`权限是【----------】，所有人都不能用？没关系，root基本上是不瘦系统的权限所限制的，无论文档权限为何，预设 root 都可以存取。  

- 团队开发软件或资料共同的功能
	- 例如有一个开发团队，一个文档只允许此团队读写执行，权限可设置为【-rwxrwx---】，然后把该团队加入到该组中。  

- 未将权限设定妥当的危害：
	- 例如只有root可以做的开关机，改成任何人都可以执行的话，就非常危险了。

可怕吧！因此，在修改Linux档案与目录的属性之前，一定要先搞情况，什么资料是可变的，什么是不可变的！千万要注意！

### 2.2、如何改变档案属性与权限：chgrp、chown、chmod

- chgrp:改变档案所属群组
- chown:改变档案拥有者
- chmod:改变档案的权限，SUID、SGID、SBIT等等的特性

----

#### 改变所属群组，chgrp

- 要被改变的群组名称必须要在`/etc/group`档案内存在才行，否则就会显示错误！  

`# chgrp [-R] dirname/filename ....`   
选项与参数：-R 表示递归（recursive）的持续变更，即连同次目录下的所有档案、目录都更新称为这个群组之意。常常用在变更某一目录内所有的档案之情况。  


#### 改变档案拥有者，chown

- 要改变的拥有者必须是已经存在系统中的账号，即在`/etc/passwd`问卷中有记录的使用者名称才能改变。  
- chown的用途蛮多的，他还可以顺便直接修改群组的名称！此外，如果要连目录下的所有文件目录或文档递归改变，直接加 -R 选项即可。  

```
# chown [-R] 账号名称 档案或目录
# chown [-R] 账号名称:群组名称 档案或目录
选项与参数：
-R ： 进行递归（recursive）改变，即连同次目录下的所有文档、目录都改变。  
```

Tips:事实上，chown也可以使用 【chown user.group file】,即在用户名和用户组之间加【.】也行！不过很多朋友喜欢在设置账号的时候就用小数点，所以为了避系统的误判断，建议使用【:】来分隔用户名和组名。  
此外，chown也能单纯的修改所属组，例如【chown .sshd initial.cfg】就是修改群组，这就是那个小数点的用途。  

- **chown或chgrp在什么时候用呢？**  
的确有些情况需要使用，例如你需要cp一些文件给其他人用的时候，拷贝的所属组和拥有者，还是你，所以别人无法修改，这个时候就必须要修改拥有者和群组了。  

#### 改变权限，chmod

改变权限用chmod这个指令，但是权限设定有两种方法：使用数字变更、使用符号变更  

##### 数字类型改变档案权限

Linux档案的基本权限就有九个，分别是 owner/group/others 三种身份，各有自己的 read/write/execute 权限。  
【-rwxrwxrwx】这九个权限是三个三个一组的，其中，我们可以用数字来代表各个权限，对照表如下：  

```
r : 4
w : 2
x : 1
```

每种身份（owner/group/others）各自的三个权限（r/w/x）分数是需要累加的，例如：【-rwxrwx---】  

```
owner = rwx = 4+2+1 = 7
group = rwx = 4+2+1 = 7
others = --- = 0+0+0 = 0
```

所以，我们在设定档案权限的时候就可以用770这个数字了。  

语法如下：  

```
# chmod [-R] xyz 档案或目录
选项与参数：
xyz:就是刚刚提到的数字类型的权限属性，为 rwx 属性数值的相加。
-R：进行递归（recursive）的持续变更，亦即连同次目录下的所有档案都会变更。
```

- 实际系统运行中最常发生的一个问题就是，vim写一个shell的批处理文档后，他的权限是 664 ，如果想要编程可执行文件并且不让别人修改的话，就需要改成 755 权限了。  
- 不希望被其他人看到的文档，应该设置为 740 。  


##### 符号类型改变档案权限

之前说了，九个权限分别是（1）user、（2）group、（3）others三种身份！那么我们就可以用 `u,g,o` 来代表这三种身份的权限。  
此外，a 则代表 all 即全部的身份！  
读写执行的权限就谢伟 `r,w,x`   

```
	u	+(加入)		r
chmod	g	-(除去)		w	档案或目录
	o	=(设定)		x
	a
```

实操一下：例如一个档案权限改为【-rwxr-xr-x】时，基本上是：

	- user(u)：具有读写执行权限
	- group和others(g/o)：具有读与执行权限

所以就是：  

```
# chmod u=rwx,go=rx filename
注意： u=rwx,go=rx 是连在一起的，中间并没有任何空白字符!
```

如果需要所有觉得都加上或者去除执行权限，如下：

```
# chmod a+x filename
# chmod a-x filename
```


### 2.3、目录与档案之权限意义：，资料夹与抽屉，各种动作所需最小权限

通过前面我们了解了权限对于档案资料安全的重要性，那么一般文档和目录有何不同呢？大有不同↓  

#### 权限对档案的重要性

文档（档案）是市级含有资料的地方，包括一般文字、资料库内容档、二进制可执行档案（binary program）等等。因此，权限对于档案来说，他的意义是真有的：  

- r（read）：可读取此以档案的实际内容，如读取文字档的文字内容等；
- w（write）：可以编辑、新增或者是修改该档案的内容（但不含删除该档案）；
- x（eXecute）：该档案具有可以被系统执行的权限。  

那个可读（r）代表读取档案内容是还好理解，那么这个可执行（x）呢？  
这里必须要小心啦！  
在windows下，一个档案是否可执行是由【副档名】来判断的，例如：.exe、.bat....等等，但是在Linux下，我们的文档是否能被执行，则是由是否具有【x】这个权限来决定的！跟档名是没有绝对关系的！  

至于【w】是，具有w权限时，你可以具有【写入、编辑、熙增、修改】档案的内容的权限，但是**并不具备删除该档案本身的权限！**  
对于档案的 rwx 来说，主要都是针对【档案的内容】而言，与档案名的存在与否没有关系，因为档案记录的是实际的资料！  

#### 权限对目录的重要性

文档是存放实际资料的所在，目录主要的内容在记录档案清单，档名与目录有强烈的关联，那么目录的rwx是什么意义呢？  

- r（read contents in directory）：
	- 表示具有读取目录结构清单的权限，当具有（r）权限时，可以查询该目录名下的档名资料，所以可以利用ls将目录的内容列表显示出来！  

- w（modify comtents of directory）：
	- 这个写入权限对目录来说真的是非常了解不起的！**因为他表示你具有变动该目录结构清单的权限**，也就是如下这些权限：
	1. 建立新的档案与目录；
	2. 删除已经存在的档案与目录（不论该档案的权限为何！）
	3. 将已存在的档案或目录进行更名；
	4. 搬移该目录内的档案、目录位置。

总之，目录的w权限就是该目录底下的档名异动有关就对了。  

- x（access directory）：
	- 目录不可以被执行，但是**目录的x代表的是使用者能否进入该目录称为工作目录的用途**的作用！所谓的工作目录（work directory）就是你目前所在的目录了！  
	- 例如：当你登入Linux时，你所在的家目录就是你当下的工作目录。变换目录的指令是【cd】（change directory）。  

----

假设【档案是一堆文件资料夹】，所以你可以在上面写/改一些资料。  
而【目录是一堆抽屉】，因此可以将资料夹分类放到不同的抽屉去。抽屉最大的目的是 拿出/放入资料夹。  

如下对比：  

| 元件 | 内容 | 叠代物件 | r | w | x |
|:----:|:----:|:----:|:----:|:----:|:----:|
| 档案 | 详细资料data | 文件资料夹 | 读到文件内容 | 修改文件内容 | 执行文件内容 |
| 目录 | 档名 | 可分类抽屉 | 读到档名 | 修改档名 | 进入该目录的权限（key） |

一般档案：rwx主要针对【档案的内容】来设计权限。  
目录：rwx主要针对【目录内的档名列表】俩设计权限，其中最有趣的x权限的设计，就当当与【该目录，也就是该抽屉的“要是”】，没有钥匙怎么能够打开抽屉呢？  


例如：【drwxr--r--】**其他人可以查看目录的档名列表，但不可以切换到此目录（非常重要）**  
如果你在某目录下不具有x的权限，那么你就无法cd到该目录，也就无法执行目录下的任何指令，即使你具有该目录的r或w的权限。  

很多人建网站时，别人显示无法查阅档案内容（显示权限不足），要注意：**要开放目录给别人浏览时，应该至少也要给予r及x的权限，但w的权限不可随便给**  

- 为什么w权限不能随便给？

例如：在用户家目录有一个文档是【-rwx------ root root】的文件，那么对于这个用户而言，这个是root的文件，root的组，而用户只是other，所以无法读、写、执行，但是因为用户对于文件夹具有rwx权限，所以用户可以直接删除该文档。  

----

实例：

- 先用root的身份建立所需要的檔案與目錄環境

我們用root的身份在所有人都可以工作的/tmp目錄中建立一個名為testing的目錄， 該目錄的權限為744且目錄擁有者為root。另外，在testing目錄下在建立一個空的檔案， 檔名亦為testing。建立目錄可用mkdir(make directory)，建立空檔案可用touch(下一章會說明)來處理。  

```
[root@study ~]# cd /tmp                     <==切換工作目錄到/tmp
[root@study tmp]# mkdir testing             <==建立新目錄
[root@study tmp]# chmod 744 testing         <==變更權限
[root@study tmp]# touch testing/testing     <==建立空的檔案
[root@study tmp]# chmod 600 testing/testing <==變更權限
[root@study tmp]# ls -ald testing testing/testing
drwxr--r--. 2 root root 20 Jun  3 01:00 testing
-rw-------. 1 root root  0 Jun  3 01:00 testing/testing
# 仔細看一下，目錄的權限是 744 ，且所屬群組與使用者均是 root 喔！
# 那麼在這樣的情況底下，一般身份使用者對這個目錄/檔案的權限為何？
```

- 一般用戶的讀寫權限為何？觀察中

在上面的例子中，雖然目錄是744的權限設定，一般用戶應該能有 r 的權限， 但這樣的權限使用者能做啥事呢？由於鳥哥的系統中含有一個帳號名為 dmtsai 的，請再開另外一個終端機，使用 dmtsai 登入來操作底下的任務！

```
[dmtsai@study ~]$ cd /tmp
[dmtsai@study tmp]$ ls -l testing/
ls: cannot access testing/testing: Permission denied
total 0
?????????? ? ? ? ?            ? testing
# 雖然有告知權限不足，但因為具有 r 的權限可以查詢檔名。由於權限不足(沒有x)，所以會有一堆問號。
[dmtsai@study tmp]$ cd testing/
-bash: cd: testing/: Permission denied
# 因為不具有 x ，所以當然沒有進入的權限啦！有沒有呼應前面的權限說明啊！
```

- 如果該目錄屬於用戶本身，會有什麼狀況？

上面的練習我們知道了只有r確實可以讓使用者讀取目錄的檔名列表，不過詳細的資訊卻還是讀不到的， 同時也不能將該目錄變成工作目錄(用 cd 進入該目錄之意)。那如果我們讓該目錄變成使用者的， 那麼使用者在這個目錄底下是否能夠刪除檔案呢？底下的練習做看看：


```
# 1. 先用 root 的身份來搞定 /tmp/testing 的屬性、權限設定：
[root@study tmp]# chown dmtsai /tmp/testing
[root@study tmp]# ls -ld /tmp/testing
drwxr--r--. 2 dmtsai root 20  6月  3 01:00 /tmp/testing  # dmtsai 是具有全部權限的！

# 2. 再用 dmtsai 的帳號來處理一下 /tmp/testing/testing 這個檔案看看：
[dmtsai@study tmp]$ cd /tmp/testing
[dmtsai@study testing]$ ls -l  <==確實是可以進入目錄
-rw-------. 1 root root 0 Jun  3 01:00 testing  <==檔案不是vbird的！
[dmtsai@study testing]$ rm testing     <==嘗試殺掉這個檔案看看！
rm: remove write-protected regular empty file `testing'? y
# 竟然可以刪除！這樣理解了嗎？！
```

透過上面這個簡單的步驟，你就可以清楚的知道， x 在目錄當中是與『能否進入該目錄』有關， 至於那個 w 則具有相當重要的權限，因為他可以讓使用者刪除、更新、新建檔案或目錄， 是個很重要的參數啊！這樣可以理解了嗎？！ 

----

#### 使用者操作功能与权限

假设有两个档名分别如下

- /dir1/file1
- /dir2

假设用普通用户账户，针对/dir1,/dir1/file1,/dir2 这三个档名来说，分别需要【哪些最小权限】才能达成各项任务？整理如下：  

| 操作动作 | /dir1 | /dir1/file1 | /dir2 | 重点 |
|:----:|:----:|:----:|:----:|:----:|
| 读取 file1 内容 | x | r | - | 要能够进入 /dir1 才能读到里面文件资料！ |
| 修改 file1 内容 | x | rw | - | 能够进入 /dir1 且修改 file1 才行！ |
| 执行 file1 内容 | x | rx | - | 能够进入 /dir1 且 file1 能运作才行！ |
| 删除 file1 档案 | wx | - | - | 能够进入 /dir1 具有目录修改的权限即可！ |
| 将 file1 复制到 /dir2 | x | r | wx | 要能够读 file1 且能够修改 /dir2 内的资料 |

你可能會問，上面的表格當中，很多時候 /dir1 都不必有 r 耶！為啥？我們知道 /dir1 是個目錄，也是個抽屜！那個抽屜的 r 代表『這個抽屜裡面有燈光』， 所以你能看到的抽屜內的所有資料夾名稱 (非內容)。但你已經知道裡面的資料夾放在哪個地方，那，有沒有燈光有差嘛？你還是可以摸黑拿到該資料夾的！對吧！ 因此，上面很多動作中，你只要具有 x 即可！r 是非必備的！只是，沒有 r 的話，使用 [tab] 時，他就無法自動幫你補齊檔名了！這樣理解乎？

看了上面這個表格，你應該會覺得很可怕喔！因為，要讀一個檔案時，你得要具有『這個檔案所在目錄的 x 權限』才行！所以，通常要開放的目錄， 至少會具備 rx 這兩個權限！現在你知道為啥了吧？



### 2.4、Linux档案种类与副档名



---

## 3、Linux目录配置

### 3.1、Linux目录配置的依据--FHS：/,/usr,/var

### 3.2、目录树(directory tree)

### 3.3、绝对路径与相对路径


### 3.4、CentOS的观察：lsb_release





----

## 4、重点回顾














